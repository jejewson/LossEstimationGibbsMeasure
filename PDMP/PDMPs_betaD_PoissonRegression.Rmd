---
title: "PDMPs for betaD Poisson Regression"
author: "Jack Jewson"
date: "7 May 2024"
output: html_document
---

## Preamble {.tabset}

### Working directory

+ Change this to be the directory that the stan files are saved in 

```{r setwd, include=TRUE,echo=TRUE, eval=TRUE,cache=TRUE}

my_dir <- "C:/Users/jjew0003/Documents/Monash_Yr1/PDMPs_IntractableLikelihood/"


```

### Packages

Loading the required packages.

```{r packages, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
library(actuar)
library(metRology)
library(LaplacesDemon)

library(rstan)
rstan_options(auto_write = TRUE)

library(mvtnorm)
library(numDeriv)
```


### RCPP

```{r RCPP, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
library(Rcpp)

setwd(my_dir)

sourceCpp("betaD_PoissonRegression_arma.cpp")
```

### stan

```{r stan, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

setwd(my_dir)

#http://discourse.mc-stan.org/t/stan-recompile-to-avoid-r-from-crashing/2631
betaBayes_Poisson_linearmodel_stan <- stan_model(file="betaBayes_Poisson_linearmodel.stan")


```

### betaD


```{r betaD, include=TRUE, echo=TRUE, eval=FALSE, cache=FALSE}

dpoisRegression <- function(y, X, theta, log){
  Xtheta <- X%*%theta
  if(log){
    out <- y*Xtheta - exp(Xtheta) - lfactorial(y)
  }
  if(!log){
    out <- exp(y*Xtheta - exp(Xtheta) - lfactorial(y))
  }
  return(out)
}

set.seed(1)

n <- 100
p <- 4
X <- matrix(rnorm(n*p, 0, 1), nrow = n, ncol = p)
theta <- c(1.3, -0.2, 0.7, -2.1)

y <- rpois(n, lambda = exp(X%*%theta))

sum(dpoisRegression(y, X, theta, log = TRUE))
sum(log(dpoisRegression(y, X, theta, log = FALSE)))
sum(dpois(y, lambda = exp(X%*%theta), log = TRUE))

#sum(abs(dpoisRegression(y, X, theta, log = FALSE) - dpoisRegression_vec_cpp_arma(y, X, theta)))

dpoisRegression(y[1], X[1,], theta, log = FALSE)
dpoisRegression_cpp_arma(y[1], X[1,], theta)
dpoisRegression_vec_cpp_arma(y[1], X[1,], theta)

dpoisRegression(y[4], X[4,], theta, log = FALSE)
dpoisRegression_cpp_arma(y[4], X[4,], theta)
dpoisRegression(y[5], X[4,], theta, log = FALSE)
dpoisRegression_vec_cpp_arma(y[4:5], X[4,], theta)


grad_log_dpoisRegression <- function(y, X, theta){
  n <- length(y)
  #if(length(y) == 1){
  if(is.null(dim(X))){
    p <- length(X)
  } else{
    p <- ncol(X)
  }
  out <- matrix(NA, nrow = n, ncol = p)
  for(j in 1:p){
    out[,j] <- X[,j]*c(y - c(exp(X%*%theta)))
  }
  
  return(out)
}

grad_log_dpoisRegression(y[1:10], X[1:10,], theta)

grad(function(theta){dpoisRegression(y[1], X[1,], theta, log = TRUE)}, theta)
grad(function(theta){dpoisRegression(y[4], X[4,], theta, log = TRUE)}, theta)

sum(abs(grad_log_dpoisRegression(y, X, theta) - grad_log_dpoisRegression_cpp_arma(y, X, theta)))

grad_dpoisRegression <- function(y, X, theta){
  n <- length(y)
  Xtheta <- X%*%theta
  #if(length(y) == 1){
  if(is.null(dim(X))){
    p <- length(X)
  } else{
    p <- ncol(X)
  }
  out <- matrix(NA, nrow = n, ncol = p)
  for(j in 1:p){
    out[,j] <- X[,j]*((y - exp(Xtheta))*exp(y*Xtheta - exp(Xtheta) - lfactorial(y)))
  }
  
  return(out)
}

grad_dpoisRegression(y[1:10], X[1:10,], theta)

grad(function(theta){dpoisRegression(y[1], X[1,], theta, log = FALSE)}, theta)
grad(function(theta){dpoisRegression(y[4], X[4,], theta, log = FALSE)}, theta)

#sum(abs(grad_dpoisRegression(y, X, theta) - grad_dpoisRegression_cpp_arma(y, X, theta)))

betaD_loss_poisRegression <- function(y, X, theta, beta, trunc = 100){
  
  n <- length(y)
  out <- rep(NA, n)
  for(i in 1:n){
    out[i] <- 1/beta*sum(dpois(0:trunc, exp(X[i,]%*%theta))^beta) - 1/(beta - 1)*dpois(y[i], exp(X[i,]%*%theta))^(beta - 1)
  }
  
  return(out)
}

grad_betaD_loss_poisRegression <- function(y, X, theta, beta, trunc = 100){
  
  n <- length(y)
  p <- ncol(X)
  out <- matrix(NA, nrow = n, ncol = p)
  for(i in 1:n){
    out[i,] <- colSums(matrix(dpois(0:trunc, exp(X[i,]%*%theta))^beta, nrow = trunc+1, ncol = p, byrow = FALSE)*grad_log_dpoisRegression(0:trunc, array(X[i,], dim = c(1, p)), theta)) - dpois(y[i], exp(X[i,]%*%theta))^(beta - 2)*grad_dpoisRegression(y[i], array(X[i,], dim = c(1, p)), theta)
  }
  
  return(out)
}

beta <- 1.5

grad_betaD_loss_poisRegression(y[c(1, 4)], X[c(1, 4),], theta, beta, trunc = 1000)

grad(function(theta){betaD_loss_poisRegression(y[1], array(X[1,], dim = c(1, p)), theta, beta, trunc = 1000)}, theta)
grad(function(theta){betaD_loss_poisRegression(y[4], array(X[4,], dim = c(1, p)), theta, beta, trunc = 1000)}, theta)

dpoisRegression_vec_cpp_arma(y[1:5], X[1,], theta)

grad_betaD_loss_poisRegressionOneObs_cpp_arma(1, y[1], y[2:5], X[1,], theta, beta)



```

## Computational Bounds

```{r ComputationalBounds, include=TRUE, echo=TRUE, eval=FALSE, cache=FALSE}


term <- function(y, beta, Xtheta){
  return(exp((beta-1)*y*Xtheta - (beta-1)*exp(Xtheta) - (beta - 1)*lfactorial(y))*(y-exp(Xtheta)))
}

beta <- 1.5
y <- 5
Xtheta_seq <- seq(-10, 10, length.out = 1000)

plot(Xtheta_seq, term(y, beta, Xtheta_seq))
abline(v = log((2*y*(beta - 1) + 1) + sqrt(4*y*(beta-1) + 1)/(2*(beta-1))), lwd = 2, lty = 2, col = "red")
abline(v = log((2*y*(beta - 1) + 1) - sqrt(4*y*(beta-1) + 1)/(2*(beta-1))), lwd = 2, lty = 2, col = "red")

y_seq <- seq(0, 10000, length.out = 10001)


plot(y_seq, pmax(term(y_seq, beta, Xtheta = log((2*y_seq*(beta - 1) + 1) + sqrt(4*y_seq*(beta-1) + 1)/(2*(beta-1)))), term(y_seq, beta, Xtheta = log((2*y_seq*(beta - 1) + 1) - sqrt(4*y_seq*(beta-1) + 1)/(2*(beta-1))))))


## This is all hat matters 
lambda <- 5
u_seq <- 0:5000

beta <- 2
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.5
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.1
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.01
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.001
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

lambda <- 0.5
u_seq <- 0:5000

beta <- 2
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.5
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.1
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.01
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.001
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))



lambda <- 500
u_seq <- 0:50000

beta <- 2
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.5
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.1
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.01
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))

beta <- 1.001
plot(u_seq, exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE)), type = "l")
sum((exp(log(u_seq) + (beta - 1)*dpois(u_seq, lambda, log = TRUE))) > (lambda+1)/(beta-1))


```

# Poisson Regression Data - n = 100 {.tabset}

## Data

```{r data_poisson_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}
set.seed(1)

N_rep <- 1

p <- 5

theta <- c(1, 0.5, 1.5, 0, 0)

n <- 100
#n <- 5000

X <- cbind(1, matrix(rnorm(n*(p-1), 0, 0.25), nrow = n, ncol = p-1))

y <- rpois(n, exp(X%*%theta))

max(rowSums(abs(X)))

```

## Prior

```{r prior_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m_0 <- 0
s_0 <- 1

```

## Stan with truncation

I got terrible inference for T = 100 as we have up to y = 9500 here

With T = 2000, this now takes a long time

```{r betaD_PoissonRegression_stan_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

iterations <- 1000
warmup <- 1000

betaBayes_Poisson_linearmodel_data <- list(n = n, p = p, y = matrix(y, nrow = n, ncol = 1), X = X, mu_beta = m_0, beta_s = s_0^2, w = 1.5, beta_p = 0.5, T = 2000, T_vect = 0:2000)

betaBayes_Poisson_linearmodel <- sampling(object = betaBayes_Poisson_linearmodel_stan, data = betaBayes_Poisson_linearmodel_data, iter = iterations + warmup, warmup = warmup, chains = 1, cores = 1
      #, control = list(adapt_delta = 0.95)#, stepsize = 0.01))
      , init = list(c1 = list(beta = rep(0, p)))
)
betaBayes_Poisson_linearmodel_params <- extract(betaBayes_Poisson_linearmodel)

```

```{r betaD_PoissonRegression_stan_diag_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

get_elapsed_time(betaBayes_Poisson_linearmodel)

for(j in 1:p){
  plot(density(betaBayes_Poisson_linearmodel_params$beta[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(betaBayes_Poisson_linearmodel_params$beta)

```

## PDMP 

### Calibration Weight

```{r calibration_weight_betaD_PoissonRegression_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

```

### set-up 

```{r betaD_PoissonRegression_setup_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

sum_abs_X_max <- max(rowSums(abs(X)))

```

## m = 5 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m5_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 5

T_end <- 1000*sqrt(100)/sqrt(n)
#T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m5_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m5_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m5_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m5_n100_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m5_rcpp.end, timer_betaD_PoissonRegression_m5_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m5_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m5_rcpp[,1:p])

```

## m = 20 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m20_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 20

T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m20_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m20_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m20_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m20_n100_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m20_rcpp.end, timer_betaD_PoissonRegression_m20_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m20_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m20_rcpp[,1:p])

```

## m = 50 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m50_n100, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 50

T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m50_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m50_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m50_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m50_n100_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m50_rcpp.end, timer_betaD_PoissonRegression_m50_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m50_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m50_rcpp[,1:p])

```

```{r betaD_PoissonRegression_skeleton_m50_n100_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)


plot(density(sample_betaD_PoissonRegression_m5_rcpp[,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("Poisson regression $n = $", n), xlim = c(theta[1] - 1, theta[1] + 1), ylim = c(0, 3.5))
lines(density(sample_betaD_PoissonRegression_m20_rcpp[,1]), lwd = 3, col = "darkgrey", lty = 2)
lines(density(sample_betaD_PoissonRegression_m50_rcpp[,1]), lwd = 3, col = "lightgrey", lty = 3)
abline(v = theta[1], lwd = 3, lty = 2, col = "red")
legend("topright", c("$m = 5$", "$m = 20$", "$m = 50$", "truth"), col = c("black", "darkgrey", "lightgrey" , "red"), lwd = rep(5, 4), lty = c(1, 2, 3, 2), bty = "n")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_m5_rcpp[,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("Poisson regression $n = $", n), xlim = c(theta[j] - 2, theta[j] + 2), ylim = c(0, 1))
   lines(density(sample_betaD_PoissonRegression_m20_rcpp[,j]), lwd = 3, col = "darkgrey", lty = 2)
  lines(density(sample_betaD_PoissonRegression_m50_rcpp[,j]), lwd = 3, col = "lightgrey", lty = 3)
abline(v = theta[j], lwd = 3, lty = 2, col = "red")
  if(j == 1){
    legend("topright", c("$m = 5$", "$m = 20$", "$m = 50$", "truth"), col = c("black", "darkgrey", "lightgrey" , "red"), lwd = rep(5, 4), lty = c(1, 2, 3, 2), bty = "n")
  }
}



```

# Poisson Regression Data - n = 100 - Repeated MCMC {.tabset}

## Data

```{r data_poisson_n100_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}
set.seed(1)

N_rep <- 1

p <- 5

theta <- c(1, 0.5, 1.5, 0, 0)

n <- 100

X <- cbind(1, matrix(rnorm(n*(p-1), 0, 0.25), nrow = n, ncol = p-1))

y <- rpois(n, exp(X%*%theta))

```

## Prior

```{r prior_n100_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m_0 <- 0
s_0 <- 1

```

### set-up 

```{r betaD_PoissonRegression_setup_n100_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

sum_abs_X_max <- max(rowSums(abs(X)))

N_rep <- 25

```


## m = 5 repeated (Rcpp)

```{r betaD_PoissonRegression_skeleton_m5_n100_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 5


T_end <- 500

set.seed(1)

sample_betaD_PoissonRegression_IntractLik_m5 <- list()
timer_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
max_alpha_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
mean_alpha_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
ESS_betaD_PoissonRegression_IntractLik_m5 <- matrix(NA, nrow = N_rep, ncol = p)

for(j in 1:N_rep){

  xi_0 <- rnorm(p, 0, 1)
  theta_0 <- sample(c(-1, 1), p, replace = TRUE)

  timer_MMD_betaD_PoissonRegression_m5.start <- Sys.time()
  skeleton_betaD_PoissonRegression_IntractLik_m5 <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_MMD_betaD_PoissonRegression_m5.end <- Sys.time()
  
  timer_betaD_PoissonRegression_IntractLik_m5[j] <- difftime(timer_MMD_betaD_PoissonRegression_m5.end, timer_MMD_betaD_PoissonRegression_m5.start, units = "mins")
  
  max_alpha_betaD_PoissonRegression_IntractLik_m5[j] <- skeleton_betaD_PoissonRegression_IntractLik_m5$max_alpha
  mean_alpha_betaD_PoissonRegression_IntractLik_m5[j] <- skeleton_betaD_PoissonRegression_IntractLik_m5$mean_alpha

  sample_betaD_PoissonRegression_IntractLik_m5[[j]] <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_Theta, N = 1000)
  
  ESS_betaD_PoissonRegression_IntractLik_m5[j,] <- ESS(sample_betaD_PoissonRegression_IntractLik_m5[[j]][,1:(p)])
  
  cat("Repeat", j, "done", "\n")
}



```


```{r betaD_PoissonRegression_skeleton_m5_n100_rep_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

mean(timer_betaD_PoissonRegression_IntractLik_m5)
mean(ESS_betaD_PoissonRegression_IntractLik_m5)

mean(mean_alpha_betaD_PoissonRegression_IntractLik_m5)
max(max_alpha_betaD_PoissonRegression_IntractLik_m5)


plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 3.5), xlim = c(theta[1] - 1, theta[1] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 1), xlim = c(theta[j] - 2, theta[j] + 2))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

```{r betaD_PoissonRegression_skeleton_m5_n100_rep_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)


plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 3.5), xlim = c(theta[1] - 1, theta[1] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 1), xlim = c(theta[j] - 2, theta[j] + 2))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

## m = 20 repeated (Rcpp)

```{r betaD_PoissonRegression_skeleton_m20_n100_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 20


T_end <- 500

set.seed(1)

sample_betaD_PoissonRegression_IntractLik_m20 <- list()
timer_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
max_alpha_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
mean_alpha_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
ESS_betaD_PoissonRegression_IntractLik_m20 <- matrix(NA, nrow = N_rep, ncol = p)

for(j in 1:N_rep){

  xi_0 <- rnorm(p, 0, 1)
  theta_0 <- sample(c(-1, 1), p, replace = TRUE)

  timer_MMD_betaD_PoissonRegression_m20.start <- Sys.time()
  skeleton_betaD_PoissonRegression_IntractLik_m20 <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_MMD_betaD_PoissonRegression_m20.end <- Sys.time()
  
  timer_betaD_PoissonRegression_IntractLik_m20[j] <- difftime(timer_MMD_betaD_PoissonRegression_m20.end, timer_MMD_betaD_PoissonRegression_m20.start, units = "mins")
  
  max_alpha_betaD_PoissonRegression_IntractLik_m20[j] <- skeleton_betaD_PoissonRegression_IntractLik_m20$max_alpha
  mean_alpha_betaD_PoissonRegression_IntractLik_m20[j] <- skeleton_betaD_PoissonRegression_IntractLik_m20$mean_alpha

  sample_betaD_PoissonRegression_IntractLik_m20[[j]] <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_Theta, N = 1000)
  
  ESS_betaD_PoissonRegression_IntractLik_m20[j,] <- ESS(sample_betaD_PoissonRegression_IntractLik_m20[[j]][,1:(p)])
  
  cat("Repeat", j, "done", "\n")
}



```


```{r betaD_PoissonRegression_skeleton_m20_n100_rep_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

mean(timer_betaD_PoissonRegression_IntractLik_m20)
mean(ESS_betaD_PoissonRegression_IntractLik_m20)

mean(mean_alpha_betaD_PoissonRegression_IntractLik_m20)
max(max_alpha_betaD_PoissonRegression_IntractLik_m20)



plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 3.5), xlim = c(theta[1] - 1, theta[1] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 1), xlim = c(theta[j] - 2, theta[j] + 2))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

```{r betaD_PoissonRegression_skeleton_m20_n100_rep_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)


plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 3.5), xlim = c(theta[1] - 1, theta[1] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 1), xlim = c(theta[j] - 2, theta[j] + 2))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```


# Poisson Regression Data - n = 500 {.tabset}

## Data

```{r data_poisson_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}
set.seed(1)

N_rep <- 1

p <- 5

theta <- c(1, 0.5, 1.5, 0, 0)

n <- 500

X <- cbind(1, matrix(rnorm(n*(p-1), 0, 0.25), nrow = n, ncol = p-1))

y <- rpois(n, exp(X%*%theta))

```

## Prior

```{r prior_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m_0 <- 0
s_0 <- 1

```

## Stan with truncation

I got terrible inference for T = 100 as we have up to y = 9500 here

With T = 2000, this now takes a long time

```{r betaD_PoissonRegression_stan_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

iterations <- 1000
warmup <- 1000

betaBayes_Poisson_linearmodel_data <- list(n = n, p = p, y = matrix(y, nrow = n, ncol = 1), X = X, mu_beta = m_0, beta_s = s_0^2, w = 1, beta_p = 0.5, T = 2000, T_vect = 0:2000)

betaBayes_Poisson_linearmodel <- sampling(object = betaBayes_Poisson_linearmodel_stan, data = betaBayes_Poisson_linearmodel_data, iter = iterations + warmup, warmup = warmup, chains = 1, cores = 1
      #, control = list(adapt_delta = 0.95)#, stepsize = 0.01))
      , init = list(c1 = list(beta = rep(0, p)))
)
betaBayes_Poisson_linearmodel_params <- extract(betaBayes_Poisson_linearmodel)

```

```{r betaD_PoissonRegression_stan_diag_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

get_elapsed_time(betaBayes_Poisson_linearmodel)

for(j in 1:p){
  plot(density(betaBayes_Poisson_linearmodel_params$beta[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(betaBayes_Poisson_linearmodel_params$beta)

```

## PDMP 

### Calibration Weight

```{r calibration_weight_betaD_PoissonRegression_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

```

### set-up 

```{r betaD_PoissonRegression_setup_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}



sum_abs_X_max <- max(rowSums(abs(X)))

```

## m = 5 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m5_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 5

T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m5_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m5_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m5_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m5_n500_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m5_rcpp.end, timer_betaD_PoissonRegression_m5_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m5_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m5_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m5_rcpp[,1:p])

```

## m = 20 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m20_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 20

T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m20_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m20_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m20_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m20_n500_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m20_rcpp.end, timer_betaD_PoissonRegression_m20_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m20_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m20_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m20_rcpp[,1:p])

```

## m = 50 (Rcpp)

```{r betaD_PoissonRegression_skeleton_m50_n500, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 50

T_end <- 1000
#T_end <- 5000
xi_0 <- rep(0, p)
theta_0 <- rep(1, p)

beta <- 1.5


timer_betaD_PoissonRegression_m50_rcpp.start <- Sys.time()
skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_betaD_PoissonRegression_m50_rcpp.end <- Sys.time()

sample_betaD_PoissonRegression_m50_rcpp <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$skeleton_Theta, N = 1000)


```

```{r betaD_PoissonRegression_skeleton_m50_n500_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}
difftime(timer_betaD_PoissonRegression_m50_rcpp.end, timer_betaD_PoissonRegression_m50_rcpp.start, units = "mins")

skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$max_alpha
skeleton_betaD_PoissonRegression_IntractLik_m50_rcpp$mean_alpha

for(j in 1:p){
  plot(density(sample_betaD_PoissonRegression_m50_rcpp[,j]), ylab = "Density", xlab = paste0("theta", j), lwd = 3, main = paste("betaD-Poisson Regression"))
  lines(density(betaBayes_Poisson_linearmodel_params$beta[,j]), lwd = 3, col = "grey")
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}


ESS(sample_betaD_PoissonRegression_m50_rcpp[,1:p])

```

```{r betaD_PoissonRegression_skeleton_m50_n500_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)

plot(density(sample_betaD_PoissonRegression_m5_rcpp[,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("Poisson regression $n = $", n), xlim = c(theta[1] - 0.5, theta[1] + 0.5), ylim = c(0, 8))
lines(density(sample_betaD_PoissonRegression_m20_rcpp[,1]), lwd = 3, col = "darkgrey", lty = 2)
lines(density(sample_betaD_PoissonRegression_m50_rcpp[,1]), lwd = 3, col = "lightgrey", lty = 3)
abline(v = theta[1], lwd = 3, lty = 2, col = "red")
legend("topright", c("$m = 5$", "$m = 20$", "$m = 50$", "truth"), col = c("black", "darkgrey", "lightgrey" , "red"), lwd = rep(5, 4), lty = c(1, 2, 3, 2), bty = "n")

for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_m5_rcpp[,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("Poisson regression $n = $", n), xlim = c(theta[j] - 1, theta[j] + 1), ylim = c(0, 2.25))
   lines(density(sample_betaD_PoissonRegression_m20_rcpp[,j]), lwd = 3, col = "darkgrey", lty = 2)
  lines(density(sample_betaD_PoissonRegression_m50_rcpp[,j]), lwd = 3, col = "lightgrey", lty = 3)
abline(v = theta[j], lwd = 3, lty = 2, col = "red")
  if(j == 1){
    #legend("topright", c("$m = 5$", "$m = 20$", "$m = 50$", "truth"), col = c("black", "darkgrey", "lightgrey" , "red"), lwd = rep(5, 4), lty = c(1, 2, 3, 2), bty = "n")
  }
}



```

# Poisson Regression Data - n = 500 - Repeated MCMC {.tabset}

## Data

```{r data_poisson_n500_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}
set.seed(1)

N_rep <- 1

p <- 5

theta <- c(1, 0.5, 1.5, 0, 0)

n <- 500

X <- cbind(1, matrix(rnorm(n*(p-1), 0, 0.25), nrow = n, ncol = p-1))

y <- rpois(n, exp(X%*%theta))

```

## Prior

```{r prior_n500_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m_0 <- 0
s_0 <- 1

```

### set-up 

```{r betaD_PoissonRegression_setup_n500_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

sum_abs_X_max <- max(rowSums(abs(X)))

N_rep <- 25

```


## m = 5 repeated (Rcpp)

```{r betaD_PoissonRegression_skeleton_m5_n500_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 5


T_end <- 500

set.seed(1)

sample_betaD_PoissonRegression_IntractLik_m5 <- list()
timer_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
max_alpha_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
mean_alpha_betaD_PoissonRegression_IntractLik_m5 <- rep(NA, N_rep)
ESS_betaD_PoissonRegression_IntractLik_m5 <- matrix(NA, nrow = N_rep, ncol = p)

for(j in 1:N_rep){

  xi_0 <- rnorm(p, 0, 1)
  theta_0 <- sample(c(-1, 1), p, replace = TRUE)

  timer_MMD_betaD_PoissonRegression_m5.start <- Sys.time()
  skeleton_betaD_PoissonRegression_IntractLik_m5 <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_MMD_betaD_PoissonRegression_m5.end <- Sys.time()
  
  timer_betaD_PoissonRegression_IntractLik_m5[j] <- difftime(timer_MMD_betaD_PoissonRegression_m5.end, timer_MMD_betaD_PoissonRegression_m5.start, units = "mins")
  
  max_alpha_betaD_PoissonRegression_IntractLik_m5[j] <- skeleton_betaD_PoissonRegression_IntractLik_m5$max_alpha
  mean_alpha_betaD_PoissonRegression_IntractLik_m5[j] <- skeleton_betaD_PoissonRegression_IntractLik_m5$mean_alpha

  sample_betaD_PoissonRegression_IntractLik_m5[[j]] <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m5$skeleton_Theta, N = 1000)
  
  ESS_betaD_PoissonRegression_IntractLik_m5[j,] <- ESS(sample_betaD_PoissonRegression_IntractLik_m5[[j]][,1:(p)])
  
  cat("Repeat", j, "done", "\n")
}



```


```{r betaD_PoissonRegression_skeleton_m5_n500_rep_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

mean(timer_betaD_PoissonRegression_IntractLik_m5)
mean(ESS_betaD_PoissonRegression_IntractLik_m5)

mean(mean_alpha_betaD_PoissonRegression_IntractLik_m5)
max(max_alpha_betaD_PoissonRegression_IntractLik_m5)


plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 8), xlim = c(theta[1] - 0.5, theta[1] + 0.5))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 2.25), xlim = c(theta[j] - 1, theta[j] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

```{r betaD_PoissonRegression_skeleton_m5_n500_rep_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)


plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 8), xlim = c(theta[1] - 0.5, theta[1] + 0.5))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m5[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 2.25), xlim = c(theta[j] - 1, theta[j] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m5[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

## m = 20 repeated (Rcpp)

```{r betaD_PoissonRegression_skeleton_m20_n500_rep, include=TRUE, echo=TRUE, eval=TRUE, cache=TRUE}

m <- 20


T_end <- 500

set.seed(1)

sample_betaD_PoissonRegression_IntractLik_m20 <- list()
timer_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
max_alpha_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
mean_alpha_betaD_PoissonRegression_IntractLik_m20 <- rep(NA, N_rep)
ESS_betaD_PoissonRegression_IntractLik_m20 <- matrix(NA, nrow = N_rep, ncol = p)

for(j in 1:N_rep){

  xi_0 <- rnorm(p, 0, 1)
  theta_0 <- sample(c(-1, 1), p, replace = TRUE)

  timer_MMD_betaD_PoissonRegression_m20.start <- Sys.time()
  skeleton_betaD_PoissonRegression_IntractLik_m20 <- ZigZag_betaD_poisRegression_cpp_arma(T_end, xi_0, theta_0, y, X, m, beta, sum_abs_X_max, w = 1.0, m_0, s_0, N_skeleton = 100000)
timer_MMD_betaD_PoissonRegression_m20.end <- Sys.time()
  
  timer_betaD_PoissonRegression_IntractLik_m20[j] <- difftime(timer_MMD_betaD_PoissonRegression_m20.end, timer_MMD_betaD_PoissonRegression_m20.start, units = "mins")
  
  max_alpha_betaD_PoissonRegression_IntractLik_m20[j] <- skeleton_betaD_PoissonRegression_IntractLik_m20$max_alpha
  mean_alpha_betaD_PoissonRegression_IntractLik_m20[j] <- skeleton_betaD_PoissonRegression_IntractLik_m20$mean_alpha

  sample_betaD_PoissonRegression_IntractLik_m20[[j]] <- skeleton_to_sample_cpp_arma(skeleton_T = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_T, skeleton_Xi = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_Xi, skeleton_Theta = skeleton_betaD_PoissonRegression_IntractLik_m20$skeleton_Theta, N = 1000)
  
  ESS_betaD_PoissonRegression_IntractLik_m20[j,] <- ESS(sample_betaD_PoissonRegression_IntractLik_m20[[j]][,1:(p)])
  
  cat("Repeat", j, "done", "\n")
}



```


```{r betaD_PoissonRegression_skeleton_m20_n500_rep_diag, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE}

mean(timer_betaD_PoissonRegression_IntractLik_m20)
mean(ESS_betaD_PoissonRegression_IntractLik_m20)

mean(mean_alpha_betaD_PoissonRegression_IntractLik_m20)
max(max_alpha_betaD_PoissonRegression_IntractLik_m20)



plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 8), xlim = c(theta[1] - 0.5, theta[1] + 0.5))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 2.25), xlim = c(theta[j] - 1, theta[j] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```

```{r betaD_PoissonRegression_skeleton_m20_n500_rep_diag_tikz, include=TRUE, echo=TRUE, eval=TRUE, cache=FALSE, fig.height = 3, fig.width = 5, dev = "tikz"}
par(mar = c(3.5, 3.8, 1.5, 1.1)) # bottom, left, top, right
par(mgp = c(2.15, 1, 0))
par(cex.lab = 1.25, cex.axis = 1.25, cex.main = 1.25)


plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,1]), ylab = "Density", xlab = paste0("$\\theta_", 1,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 8), xlim = c(theta[1] - 0.5, theta[1] + 0.5))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,1]), lwd = 3)
  }
abline(v = theta[1], lwd = 3, lty = 2, col = "red")


for(j in 2:p){
  plot(density(sample_betaD_PoissonRegression_IntractLik_m20[[1]][,j]), ylab = "Density", xlab = paste0("$\\theta_", j,"$"), lwd = 3, main = paste("$\\beta$D Poisson regression $n = $", n, "$m =$", m), ylim = c(0, 2.25), xlim = c(theta[j] - 1, theta[j] + 1))
  for(i in 2:N_rep){
    lines(density(sample_betaD_PoissonRegression_IntractLik_m20[[i]][,j]), lwd = 3)
  }
  abline(v = theta[j], lwd = 3, lty = 2, col = "red")
}



```



